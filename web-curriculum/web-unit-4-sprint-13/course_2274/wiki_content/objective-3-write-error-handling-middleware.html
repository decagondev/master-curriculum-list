<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Objective 3 - Write Error Handling Middleware</title>
<meta name="identifier" content="g7e41da6884f77369ae094dda7357ad84"/>
<meta name="editing_roles" content="teachers"/>
<meta name="workflow_state" content="active"/>
</head>
<body>
<p>&nbsp;</p>
<p><iframe class="wistia_embed" title="Error Handling Middleware Video" src="https://fast.wistia.net/embed/iframe/zk17r55iwj" width="640" height="360" name="wistia_embed" allow="autoplay; fullscreen" loading="lazy"></iframe></p>
<p>&nbsp;</p>
<h2 id="overview">Overview</h2>
<p>When our application encounters an error in the middle of executing middleware code, we can <strong>choose</strong> to hand over control to <em>error handling middleware</em> by calling <code>next()</code> with one argument. It is a standard convention to make that argument be an error object like this: <code>next(new Error("error message"))</code>.</p>
<p>This middleware type takes four arguments: <code>error</code>, <code>req</code>, <code>res</code>, and <code>next</code>. We pass the first argument when calling <code>next(new Error('error message here'))</code>. When the error handling code is finished, we can choose to end the request or call next without arguments to continue to the next <em>regular middleware</em>.</p>
<p><span>Error handling middleware can be placed anywhere in the stack, but it makes the most sense to put it at the end. Suppose the intention is for middleware to handle errors that may occur elsewhere in the queue. In that case, it needs to run after the rest of the middleware has run.</span></p>
<h2 id="follow-along">Follow Along</h2>
<p>Let's see this error-handling middleware in code. First, let's write an endpoint that sends a file to the client in response to a <code>GET</code> request to the <code>/download</code> endpoint.</p>
<pre style="background-image: none;  background-attachment: scroll;   background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal;   font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px;      background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none;  background-attachment: scroll;   background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal;   font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #d73a49; color: #d73a49;">const</span> express = <span style="border: 0px none #e36209; color: #e36209;">require</span>(<span style="border: 0px none #032f62; color: #032f62;">'express'</span>);<br><span style="border: 0px none #d73a49; color: #d73a49;">const</span> path = <span style="border: 0px none #e36209; color: #e36209;">require</span>(<span style="border: 0px none #032f62; color: #032f62;">'path'</span>);<br><br><span style="border: 0px none #d73a49; color: #d73a49;">const</span> server = <span style="border: 0px none #6f42c1; color: #6f42c1;">express</span>();<br><br>server.<span style="border: 0px none #6f42c1; color: #6f42c1;">get</span>(<span style="border: 0px none #032f62; color: #032f62;">'/download'</span>, <span>(<span>req, res</span>) =&gt;</span> {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">const</span> filePath = path.<span style="border: 0px none #6f42c1; color: #6f42c1;">join</span>(__dirname, <span style="border: 0px none #032f62; color: #032f62;">'index.html'</span>);<br>&nbsp;&nbsp;res.<span style="border: 0px none #6f42c1; color: #6f42c1;">sendFile</span>(filePath);<br>});<br><br>server.<span style="border: 0px none #6f42c1; color: #6f42c1;">listen</span>(<span style="border: 0px none #005cc5; color: #005cc5;">5000</span>);</code></pre>
<p>If we run our server and make a <code>GET</code> request to <code>/download</code>, the server will crash since there is no <code>index.html</code> file to send. We need to rewrite our endpoint and take advantage of the fact that <code>res.sendFile</code> supports passing a callback function as a second argument. This callback function will run after the file is sent. It will also run if there is an error in the process of sending the file.</p>
<pre style="background-image: none;  background-attachment: scroll;   background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal;   font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px;      background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none;  background-attachment: scroll;   background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal;   font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #6a737d; color: #6a737d;">// note we added the third parameter here: next</span><br>server.<span style="border: 0px none #6f42c1; color: #6f42c1;">get</span>(<span style="border: 0px none #032f62; color: #032f62;">'/download'</span>, <span>(<span>req, res, next</span>) =&gt;</span> {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">const</span> filePath = path.<span style="border: 0px none #6f42c1; color: #6f42c1;">join</span>(__dirname, <span style="border: 0px none #032f62; color: #032f62;">'index.html'</span>);<br>&nbsp;&nbsp;res.<span style="border: 0px none #6f42c1; color: #6f42c1;">sendFile</span>(filePath, <span><span>err</span> =&gt;</span> {<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #6a737d; color: #6a737d;">// if there is an error the callback function will get an error as it's first argument</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">if</span> (err) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #6a737d; color: #6a737d;">// we could handle the error here or pass it down to error-handling middleware like so:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #6f42c1; color: #6f42c1;">next</span>(err); <span style="border: 0px none #6a737d; color: #6a737d;">// call the next error-handling middleware in the queue</span><br>&nbsp;&nbsp;&nbsp;&nbsp;} <span style="border: 0px none #d73a49; color: #d73a49;">else</span> {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">console</span>.<span style="border: 0px none #6f42c1; color: #6f42c1;">log</span>(<span style="border: 0px none #032f62; color: #032f62;">'File sent successfully'</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;});<br>});</code></pre>
<p>Now let's add error-handling middleware to our server. We can create the middleware function and then <code>use</code> it like any other middleware or do it inline. Below an example of <em>using</em> it inline.</p>
<pre style="background-image: none;  background-attachment: scroll;   background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal;   font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px;      background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none;  background-attachment: scroll;   background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal;   font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;">server.<span style="border: 0px none #6f42c1; color: #6f42c1;">use</span>(<span>(<span>err, req, res, next</span>) =&gt;</span> {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">console</span>.<span style="border: 0px none #6f42c1; color: #6f42c1;">error</span>(err);<br><br>&nbsp;&nbsp;res<br>&nbsp;&nbsp;&nbsp;&nbsp;.<span style="border: 0px none #6f42c1; color: #6f42c1;">status</span>(<span style="border: 0px none #005cc5; color: #005cc5;">500</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;.<span style="border: 0px none #6f42c1; color: #6f42c1;">json</span>({ <span style="border: 0px none #005cc5; color: #005cc5;">message</span>: <span style="border: 0px none #032f62; color: #032f62;">'There was an error performing the required operation'</span> });<br>});</code></pre>
<p>This middleware will only get called if any other middleware or route handler <strong>that comes before</strong> it has called <code>next()</code> with an argument like in the <code>/download</code> endpoint above.</p>
<p>The complete code for our server now look like so:</p>
<pre style="background-image: none;  background-attachment: scroll;   background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal;   font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px;      background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none;  background-attachment: scroll;   background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal;   font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #d73a49; color: #d73a49;">const</span> express = <span style="border: 0px none #e36209; color: #e36209;">require</span>(<span style="border: 0px none #032f62; color: #032f62;">'express'</span>);<br><span style="border: 0px none #d73a49; color: #d73a49;">const</span> path = <span style="border: 0px none #e36209; color: #e36209;">require</span>(<span style="border: 0px none #032f62; color: #032f62;">'path'</span>);<br><br><span style="border: 0px none #d73a49; color: #d73a49;">const</span> server = <span style="border: 0px none #6f42c1; color: #6f42c1;">express</span>();<br><br>server.<span style="border: 0px none #6f42c1; color: #6f42c1;">get</span>(<span style="border: 0px none #032f62; color: #032f62;">'/download'</span>, <span>(<span>req, res, next</span>) =&gt;</span> {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">const</span> filePath = path.<span style="border: 0px none #6f42c1; color: #6f42c1;">join</span>(__dirname, <span style="border: 0px none #032f62; color: #032f62;">'index.html'</span>);<br>&nbsp;&nbsp;res.<span style="border: 0px none #6f42c1; color: #6f42c1;">sendFile</span>(filePath, <span><span>err</span> =&gt;</span> {<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #6a737d; color: #6a737d;">// if there is an error the callback function will get an error as it's first argument</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">if</span> (err) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #6a737d; color: #6a737d;">// we could handle the error here or pass it down to error-handling middleware like so:</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #6f42c1; color: #6f42c1;">next</span>(err); <span style="border: 0px none #6a737d; color: #6a737d;">// call the next error-handling middleware in the queue</span><br>&nbsp;&nbsp;&nbsp;&nbsp;} <span style="border: 0px none #d73a49; color: #d73a49;">else</span> {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">console</span>.<span style="border: 0px none #6f42c1; color: #6f42c1;">log</span>(<span style="border: 0px none #032f62; color: #032f62;">'File sent successfully'</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;});<br>});<br><br>server.<span style="border: 0px none #6f42c1; color: #6f42c1;">use</span>(<span>(<span>err, req, res, next</span>) =&gt;</span> {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">console</span>.<span style="border: 0px none #6f42c1; color: #6f42c1;">error</span>(err);<br><br>&nbsp;&nbsp;res<br>&nbsp;&nbsp;&nbsp;&nbsp;.<span style="border: 0px none #6f42c1; color: #6f42c1;">status</span>(<span style="border: 0px none #005cc5; color: #005cc5;">500</span>)<br>&nbsp;&nbsp;&nbsp;&nbsp;.<span style="border: 0px none #6f42c1; color: #6f42c1;">json</span>({ <span style="border: 0px none #005cc5; color: #005cc5;">message</span>: <span style="border: 0px none #032f62; color: #032f62;">'There was an error performing the required operation'</span> });<br>});<br><br>server.<span style="border: 0px none #6f42c1; color: #6f42c1;">listen</span>(<span style="border: 0px none #005cc5; color: #005cc5;">5000</span>);</code></pre>
<p><span>Open your browser and visit </span><a href="http://localhost:5000/download"><span>http://localhost:5000/download (Links to an external site)</span></a><span>, and the error message coming from our error-handling middleware should display.</span></p>
<h2 id="challenge">Challenge</h2>
<p>Write a piece of middleware that accepts an object with two properties: <code>errorCode</code> and <code>errorMessage</code>. Your middleware should respond with different messages based on the <code>errorCode</code> provided. If the error code is <code>1404</code>, return HTTP status code 404 and a <code>not found</code> message. If the code is <code>1500</code>, return a 500 status code and a generic error message.</p>
</body>
</html>