<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Objective 1 - Extract Configuration Into Environment Variables</title>
<meta name="identifier" content="g2ebb5597bcd65e1f728526496d186fa9"/>
<meta name="editing_roles" content="teachers"/>
<meta name="workflow_state" content="active"/>
</head>
<body>
<p>&nbsp;</p>
<p><iframe class="wistia_embed" title="Node Environment Variables Video" src="https://fast.wistia.net/embed/iframe/yem91fxf1l" width="640" height="360" name="wistia_embed" allow="autoplay; fullscreen" loading="lazy"></iframe></p>
<p>&nbsp;</p>
<h2 id="overview">Overview</h2>
<p>When you develop and run code on your machine, you run code in its <code>development</code> environment.</p>
<p>Most companies will have a <code>testing</code> environment similar to production; it has the same versions of software and runs on similar, albeit weaker, hardware. They do this to mitigate the risks when moving the to <code>production</code> servers that clients use.</p>
<p>Ideally, all environments run on the same stack, platforms, and versions. Still, it is common to have developers on the Windows platform with the latest version of Node.js and the <code>production</code> server running on Linux with the last stable version of Node.js. For those cases, it is essential to have a <code>testing/staging</code> environment that also runs the Linux and Node.js versions found on the production server. A staging environment can detect any regressions that may occur during deployment before code reaches the user.</p>
<h2 id="follow-along">Follow Along</h2>
<h3 id="starter-code">Starter Code</h3>
<p>You can find the starter code for this tutorial in <a href="https://github.com/BloomInstituteOfTechnology/node-api4-guided">this repository</a>.</p>
<h3 id="add-start-script">Add "start" script</h3>
<p>When we deploy the API, Heroku and similar services will look for a "start" script that uses <code>node</code> to run the server. We need to add that script to <code>package.json</code>.</p>
<p>Add a "start" script that uses <code>node</code> instead of <code>nodemon</code> to run <code>index.js</code>.</p>
<p>The "scripts" section of <code>package.json</code> should look like so:</p>
<pre style="background-image: none; background-attachment: scroll; background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal; font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px; background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="less"><code style="background-image: none; background-attachment: scroll; background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal; font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;">"<span style="border: 0px none #22863a; color: #22863a;">scripts</span>": {<br> &nbsp;&nbsp;"<span style="border: 0px none #22863a; color: #22863a;">start</span>": "<span style="border: 0px none #22863a; color: #22863a;">node</span> <span style="border: 0px none #22863a; color: #22863a;">index</span><span style="border: 0px none #005cc5; color: #005cc5;">.js</span>",<br> &nbsp;&nbsp;"<span style="border: 0px none #22863a; color: #22863a;">server</span>": "<span style="border: 0px none #22863a; color: #22863a;">nodemon</span> <span style="border: 0px none #22863a; color: #22863a;">index</span><span style="border: 0px none #005cc5; color: #005cc5;">.js</span>"<br>},</code></pre>
<p>After this change, the hosting service knows how to start our server but needs to control which <code>port</code> the API will use. The port is hard-coded as 9000, and we need to make it dynamic.</p>
<h3 id="make-the-port-dynamic">Make the Port Dynamic</h3>
<ul>
<li>Read up on the <a href="https://www.npmjs.com/package/dotenv">dotenv npm module</a>.</li>
<li>Install <code>dotenv</code> as a production dependency.</li>
<li>Change <code>index.js</code>:</li>
</ul>
<pre style="background-image: none; background-attachment: scroll; background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal; font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px; background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none; background-attachment: scroll; background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal; font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #6a737d; color: #6a737d;">// it's recommended to load configuration for .env as early as possible</span><br><span style="border: 0px none #e36209; color: #e36209;">require</span>(<span style="border: 0px none #032f62; color: #032f62;">'dotenv'</span>).<span style="border: 0px none #6f42c1; color: #6f42c1;">config</span>(); <span style="border: 0px none #6a737d; color: #6a737d;">// add this line as the first thing to run</span><br><br><code style="background-image: none; background-attachment: scroll; background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal; font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #6a737d; color: #6a737d;">// server code...</span></code><br><br><span style="border: 0px none #6a737d; color: #6a737d;">// we'll read the port from the server environment if it is there</span><br><span style="border: 0px none #6a737d; color: #6a737d;">// Heroku for example will have the PORT environment variable set already</span><br><span style="border: 0px none #d73a49; color: #d73a49;">const</span> port = process.<span>env</span>.<span>PORT</span> || <span style="border: 0px none #005cc5; color: #005cc5;">9000</span>;<br><br><span style="border: 0px none #6a737d; color: #6a737d;">// we can now use that port, use 9000 as a default if not set by either Heroku or an .env file</span><br>server.<span style="border: 0px none #6f42c1; color: #6f42c1;">listen</span>(port, <span>() =&gt;</span> {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">console</span>.<span style="border: 0px none #6f42c1; color: #6f42c1;">log</span>(<span style="border: 0px none #032f62; color: #032f62;">`\n*** Server Running on http://localhost:<span style="border: 0px none #24292e; color: #24292e;">${port}</span> ***\n`</span>);<br>});</code></pre>
<ul>
<li>add a <code>.env</code> file to the root folder (next to <code>package.json</code>) with the following content</li>
</ul>
<pre style="background-image: none; background-attachment: scroll; background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal; font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px; background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none; background-attachment: scroll; background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal; font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #005cc5; color: #005cc5;">PORT</span>=<span style="border: 0px none #005cc5; color: #005cc5;">9001</span></code></pre>
<p>It is recommended to add <code>.env</code> to <code>.gitignore</code> to prevent it from being uploaded to GitHub.</p>
<p><span>The reason is that most systems add configuration secrets to that file that are different between environments. Some examples are database connection credentials or API keys for external services.</span></p>
<ul>
<li><strong>stop the server</strong> and restart it again, or the server will not detect the change to <code>.env</code>.</li>
<li>the API should be using port <code style="background-image: none; background-attachment: scroll; background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal; font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #005cc5; color: #005cc5;">9001</span></code> now as specified in <code>.env</code>.</li>
</ul>
<h2 id="challenge">Challenge</h2>
<p>Extract all secrets and values that need to change between <code>development</code> and <code>production</code> environments.</p>
</body>
</html>