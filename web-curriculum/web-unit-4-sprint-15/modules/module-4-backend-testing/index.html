<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 4 - Backend Testing</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #1a1d23; /* Dark background color */
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #222831; /* Darker container background */
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        h1, h2, h3, h4 {
            color: #ffffff;
            margin: 0;
        }
        h1 {
            color: #ffffff;
            margin-bottom: 30px;
            border-bottom: 2px solid #ff5722; /* Orange accent color */
            padding-bottom: 10px;
        }
        h2 {
            color: #ffffff;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        h3 {
            color: #ff5722; /* Orange accent color */
            margin-top: 0;
        }
        h4 {
            color: #ffffff;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .section {
            margin-bottom: 40px;
            background-color: #2a303c;
            border-radius: 4px;
            padding: 20px;
            border: 1px solid #333a47;
        }
        .section p, .section li {
            color: #b3b3b3;
        }
        ul, ol {
            color: #b3b3b3;
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
        .button {
            display: inline-block;
            padding: 8px 16px;
            background-color: #ff5722; /* Orange accent color */
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .button:hover {
            background-color: #ff7043; /* Lighter orange on hover */
            box-shadow: 0 0 10px rgba(255, 87, 34, 0.5);
        }
        
        /* Navigation styling */
        nav {
            margin-bottom: 30px;
        }
        nav ul {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 0;
            margin-top: 20px;
        }
        nav a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #333a47;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        nav a:hover {
            background-color: #ff5722;
            box-shadow: 0 0 10px rgba(255, 87, 34, 0.5);
        }
        
        /* Module grid styling */
        .module-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .module-card {
            background-color: #333a47;
            border-radius: 6px;
            padding: 20px;
            border: 1px solid #444c5c;
            transition: transform 0.3s, box-shadow 0.3s;
          display: flex;
  flex-direction: column;
}
        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .module-card h3 {
            margin-top: 0;
            color: #ff5722;
        }
        .module-card p {
            color: #b3b3b3;
          flex-grow: 1;
}
        
        /* Video grid styling */
        .video-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-top: 20px;
        }
        .video-card {
            background-color: #333a47;
            border-radius: 6px;
            padding: 20px;
            border: 1px solid #444c5c;
            width: 100%;
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 4px;
        }
        
        /* Resources styling */
        .resource-card a {
            color: #ff5722;
            text-decoration: none;
        }
        .resource-card a:hover {
            text-decoration: none;
        }

        .resource-link-list li, .resource-link-list a {
            text-decoration: none;
            color: #ffffff;
        }

        .resource-link-list a:hover {
            text-decoration: underline;
            color: #ff5722;
        }
        
        /* Media queries */
        @media (max-width: 768px) {
            .video-grid, .module-grid {
                grid-template-columns: 1fr;
            }
            nav ul {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
        
        /* Code pre formatting */
        pre {
            background-color: #1a1d23;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            border: 1px solid #444c5c;
        }
        
        code {
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Module 4 - Backend Testing</h1>

        <div class="section">
            <h2>Backend Testing</h2>
            <p>Backend testing is crucial for ensuring the reliability and functionality of server-side applications. In this module, you'll learn how to test APIs, database interactions, and server endpoints using modern testing tools and best practices.</p>

            <h2>Learning Objectives</h2>
            <div class="module-grid">
                <div class="module-card">
                    <h3>API Testing</h3>
                    <p>Master the art of testing RESTful APIs, including request/response handling, status codes, and data validation.</p>
                </div>
                <div class="module-card">
                    <h3>Database Testing</h3>
                    <p>Learn how to test database operations, including CRUD operations, data integrity, and transaction handling.</p>
                </div>
                <div class="module-card">
                    <h3>Integration Testing</h3>
                    <p>Understand how to write and maintain integration tests that verify the interaction between different components.</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Module Content</h2>
            <div class="module-grid">
                <div class="module-card">
                    <h3>API Testing</h3>
                    <ul>
                        <li>HTTP Methods</li>
                        <li>Status Codes</li>
                        <li>Request/Response</li>
                    </ul>
                </div>
                <div class="module-card">
                    <h3>Database Testing</h3>
                    <ul>
                        <li>Test Databases</li>
                        <li>CRUD Operations</li>
                        <li>Data Integrity</li>
                    </ul>
                </div>
                <div class="module-card">
                    <h3>Integration Testing</h3>
                    <ul>
                        <li>Component Interaction</li>
                        <li>Test Environment</li>
                        <li>Mocking & Stubbing</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>API Testing Fundamentals</h2>
            
            <div class="video-grid">
                <div class="video-card">
                    <div class="video-container">
                        <iframe src="https://fast.wistia.net/embed/iframe/zyxiup0p28" title="API Testing Overview" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <h3>Integration Testing with SuperTest</h3>
                    <p>API endpoint testing focuses on ensuring that your REST endpoints properly handle requests and return the expected responses. For this, we can use tools like Supertest along with Jest.</p>
                    
                    <h4>Why Test APIs?</h4>
                    <ul>
                        <li>Ensure endpoints return correct status codes</li>
                        <li>Verify payload formats and data integrity</li>
                        <li>Confirm error handling works properly</li>
                        <li>Test authorization and authentication flows</li>
                        <li>Maintain functionality when refactoring</li>
                    </ul>
                    
                    <h4>Code Example - Setting up Supertest:</h4>
                    <pre>
const request = require('supertest');
const server = require('../api/server');

describe('server.js', () => {
  describe('GET /', () => {
    it('returns 200 OK', async () => {
      const response = await request(server).get('/');
      expect(response.status).toBe(200);
    });

    it('returns JSON', async () => {
      const response = await request(server).get('/');
      expect(response.type).toBe('application/json');
    });

    it('returns the expected message', async () => {
      const response = await request(server).get('/');
      expect(response.body.message).toBe('API is running');
    });
  });
});</pre>
                </div>
                
                <div class="video-card">
                    <div class="video-container">
                        <iframe src="https://fast.wistia.net/embed/iframe/zyxiup0p28" title="Testing Authentication Endpoints" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <h3>Testing Authentication Endpoints</h3>
                    <p>Authentication is a critical part of most applications, and it's essential to test these endpoints thoroughly.</p>
                    
                    <h4>Code Example - Testing Registration and Login:</h4>
                    <pre>
describe('Authentication Endpoints', () => {
  beforeAll(async () => {
    // Clear test database before all tests
    await db('users').truncate();
  });

  describe('POST /api/auth/register', () => {
    it('returns 201 Created when registration succeeds', async () => {
      const newUser = { username: 'testuser', password: 'password123' };
      const response = await request(server)
        .post('/api/auth/register')
        .send(newUser);
        
      expect(response.status).toBe(201);
    });
    
    it('saves the user to the database', async () => {
      const users = await db('users');
      expect(users).toHaveLength(1);
    });
    
    it('returns 400 Bad Request if username is missing', async () => {
      const invalidUser = { password: 'password123' };
      const response = await request(server)
        .post('/api/auth/register')
        .send(invalidUser);
        
      expect(response.status).toBe(400);
    });
  });
  
  describe('POST /api/auth/login', () => {
    it('returns 200 OK and token when login succeeds', async () => {
      const credentials = { username: 'testuser', password: 'password123' };
      const response = await request(server)
        .post('/api/auth/login')
        .send(credentials);
        
      expect(response.status).toBe(200);
      expect(response.body.token).toBeDefined();
    });
    
    it('returns 401 Unauthorized with invalid credentials', async () => {
      const invalidCreds = { username: 'testuser', password: 'wrongpassword' };
      const response = await request(server)
        .post('/api/auth/login')
        .send(invalidCreds);
        
      expect(response.status).toBe(401);
    });
  });
});</pre>
                </div>
                
                <div class="video-card">
                    <div class="video-container">
                        <iframe src="https://fast.wistia.net/embed/iframe/zyxiup0p28" title="Testing Protected Routes" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <h3>Testing Protected Routes</h3>
                    <p>Protected routes require a valid token for access. Testing these routes involves first obtaining a token and then using it in subsequent requests.</p>
                    
                    <h4>Code Example - Testing Protected Endpoints:</h4>
                    <pre>
describe('Protected Routes', () => {
  let token;
  
  beforeAll(async () => {
    // Clear test database
    await db('users').truncate();
    
    // Register a test user
    await request(server)
      .post('/api/auth/register')
      .send({ username: 'protecteduser', password: 'password123' });
    
    // Login to get a token
    const response = await request(server)
      .post('/api/auth/login')
      .send({ username: 'protecteduser', password: 'password123' });
    
    token = response.body.token;
  });
  
  describe('GET /api/resources', () => {
    it('returns 401 without token', async () => {
      const response = await request(server).get('/api/resources');
      expect(response.status).toBe(401);
    });
    
    it('returns 200 with valid token', async () => {
      const response = await request(server)
        .get('/api/resources')
        .set('Authorization', `Bearer ${token}`);
        
      expect(response.status).toBe(200);
      expect(Array.isArray(response.body)).toBe(true);
    });
  });
});</pre>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>Database Testing</h2>
            
            <div class="video-grid">
                <div class="video-card">
                    <div class="video-container">
                        <iframe src="https://fast.wistia.net/embed/iframe/zyxiup0p28" title="Database Access Testing" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <h3>Database Integration Testing</h3>
                    <p>Testing database operations is crucial for ensuring your data layer works correctly. This typically involves testing your models and data access functions.</p>
                    
                    <h4>Setting Up Test Database Environment</h4>
                    <p>It's important to use a separate database for testing to avoid affecting production data. A common practice is to use SQLite in-memory database for testing:</p>
                    
                    <h4>Code Example - Database Testing Setup:</h4>
                    <pre>
// knexfile.js
module.exports = {
  development: {
    client: 'sqlite3',
    connection: {
      filename: './data/dev.sqlite3'
    },
    // ... other config
  },
  testing: {
    client: 'sqlite3',
    connection: {
      filename: ':memory:'  // In-memory SQLite database
    },
    // ... other config
    seeds: {
      directory: './data/seeds'
    }
  }
};</pre>
                    
                    <h4>Database Helper Functions for Testing:</h4>
                    <pre>
// dbTestHelpers.js
const db = require('../data/dbConfig');

async function truncateAllTables() {
  // Truncate all tables to start with fresh data
  await db('users').truncate();
  await db('posts').truncate();
  await db('comments').truncate();
}

async function seedTestData() {
  // Insert test data
  await db('users').insert([
    { id: 1, username: 'testuser1', password: 'hashed_password' },
    { id: 2, username: 'testuser2', password: 'hashed_password' }
  ]);
  // ... other seed data
}

module.exports = {
  truncateAllTables,
  seedTestData
};</pre>
                </div>
                
                <div class="video-card">
                    <div class="video-container">
                        <iframe src="https://fast.wistia.net/embed/iframe/zyxiup0p28" title="Testing CRUD Operations" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <h3>Testing CRUD Operations</h3>
                    <p>For a robust application, each Create, Read, Update, and Delete operation should be thoroughly tested.</p>
                    
                    <h4>Code Example - Testing User Model:</h4>
                    <pre>
const db = require('../data/dbConfig');
const Users = require('../models/users-model');
const { truncateAllTables } = require('./dbTestHelpers');

describe('Users Model', () => {
  beforeEach(async () => {
    await truncateAllTables();
  });
  
  describe('getAll()', () => {
    it('returns an empty array if no users exist', async () => {
      const users = await Users.getAll();
      expect(users).toEqual([]);
    });
    
    it('returns all users in the database', async () => {
      // Add test users
      await db('users').insert([
        { username: 'user1', password: 'pass1' },
        { username: 'user2', password: 'pass2' }
      ]);
      
      const users = await Users.getAll();
      expect(users).toHaveLength(2);
      expect(users[0].username).toBe('user1');
      expect(users[1].username).toBe('user2');
    });
  });
  
  describe('findById()', () => {
    it('returns the user with the specified id', async () => {
      // Add a test user
      const [id] = await db('users').insert({ 
        username: 'finduser', 
        password: 'pass' 
      });
      
      const user = await Users.findById(id);
      expect(user.username).toBe('finduser');
    });
    
    it('returns undefined for non-existent id', async () => {
      const user = await Users.findById(9999);
      expect(user).toBeUndefined();
    });
  });
  
  describe('add()', () => {
    it('adds the user to the database', async () => {
      const newUser = { username: 'newuser', password: 'newpass' };
      await Users.add(newUser);
      
      const users = await db('users');
      expect(users).toHaveLength(1);
      expect(users[0].username).toBe('newuser');
    });
    
    it('returns the added user with an id', async () => {
      const newUser = { username: 'adduser', password: 'addpass' };
      const added = await Users.add(newUser);
      
      expect(added.id).toBeDefined();
      expect(added.username).toBe('adduser');
    });
  });
  
  // ... tests for update() and remove()
});</pre>
                </div>
                
                <div class="video-card">
                    <div class="video-container">
                        <iframe src="https://fast.wistia.net/embed/iframe/zyxiup0p28" title="Transaction Testing" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <h3>Testing Database Transactions</h3>
                    <p>Some database operations involve multiple steps or transactions that should be tested together.</p>
                    
                    <h4>Code Example - Testing a Complex Operation:</h4>
                    <pre>
describe('Posts Model - Complex Operations', () => {
  beforeEach(async () => {
    await truncateAllTables();
    await seedTestData();
  });
  
  describe('createPostWithTags()', () => {
    it('creates a post with multiple tags', async () => {
      const newPost = {
        title: 'Test Post',
        content: 'This is a test post',
        user_id: 1,
        tags: ['javascript', 'testing', 'jest']
      };
      
      const result = await Posts.createPostWithTags(newPost);
      
      // Check post was created
      expect(result.post.id).toBeDefined();
      expect(result.post.title).toBe('Test Post');
      
      // Check tags were created
      expect(result.tags).toHaveLength(3);
      
      // Check post-tag relationships
      const postTags = await db('post_tags')
        .where({ post_id: result.post.id });
      expect(postTags).toHaveLength(3);
    });
    
    it('rolls back if tag creation fails', async () => {
      // Mock db.transaction to simulate failure
      const originalTransaction = db.transaction;
      db.transaction = jest.fn(async (callback) => {
        const trx = {
          commit: jest.fn(),
          rollback: jest.fn(),
          insert: jest.fn(() => {
            throw new Error('Test error');
          }),
          // ... other trx methods as needed
        };
        try {
          await callback(trx);
        } catch (err) {
          await trx.rollback();
          throw err;
        }
      });
      
      const newPost = {
        title: 'Rollback Test Post',
        content: 'This should be rolled back',
        user_id: 1,
        tags: ['javascript', 'testing']
      };
      
      await expect(Posts.createPostWithTags(newPost))
        .rejects.toThrow('Test error');
      
      // Check nothing was added
      const posts = await db('posts');
      expect(posts).toHaveLength(0);
      
      // Restore original transaction function
      db.transaction = originalTransaction;
    });
  });
});</pre>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>Integration Testing Best Practices</h2>
            
            <div class="video-grid">
                <div class="video-card">
                    <div class="video-container">
                        <iframe src="https://fast.wistia.net/embed/iframe/xr8hp7d4n0" title="Integration Testing Strategy" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <h3>Integration Testing Strategy</h3>
                    <p>Test-Driven Development (TDD) is an effective approach for developing robust backend APIs. The process involves:</p>
                    
                    <ol>
                        <li>Write a failing test for the API endpoint or database function</li>
                        <li>Implement the minimal code to make the test pass</li>
                        <li>Refactor the code while keeping tests passing</li>
                    </ol>
                    
                    <h4>Benefits of TDD for Backend:</h4>
                    <ul>
                        <li>Forces you to think about how your API should behave</li>
                        <li>Ensures testable code from the start</li>
                        <li>Provides immediate feedback as you develop</li>
                        <li>Leads to modular and maintainable code</li>
                        <li>Serves as documentation for how the API works</li>
                    </ul>
                    
                    <h4>Code Example - TDD Workflow:</h4>
                    <pre>
// Step 1: Write a failing test
describe('POST /api/resources', () => {
  it('creates a new resource with valid data', async () => {
    const newResource = { name: 'Test Resource', value: 100 };
    const response = await request(server)
      .post('/api/resources')
      .send(newResource);
      
    expect(response.status).toBe(201);
    expect(response.body.id).toBeDefined();
    expect(response.body.name).toBe('Test Resource');
    
    // Verify it was saved to the database
    const resources = await db('resources');
    expect(resources).toHaveLength(1);
  });
});</pre>
                </div>
                
                <div class="video-card">
                    <div class="video-container">
                        <iframe src="https://fast.wistia.net/embed/iframe/xr8hp7d4n0" title="Test Coverage" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <h3>Measuring Test Coverage</h3>
                    <p>Jest provides built-in code coverage reporting. You can enable it by adding the <code>--coverage</code> flag to your test command:</p>
                    <pre>
// package.json
{
  "scripts": {
    "test": "jest --watch",
    "test:coverage": "jest --coverage"
  }
}</pre>
                    
                    <h4>Test Organization Tips:</h4>
                    <ul>
                        <li>Group tests by feature or component</li>
                        <li>Use descriptive test names that explain what's being tested</li>
                        <li>Follow the AAA pattern (Arrange, Act, Assert)</li>
                        <li>Keep tests independent and isolated</li>
                        <li>Use test fixtures for common test setups</li>
                    </ul>
                    
                    <pre>
// Well-organized test structure
describe('Users API', () => {
  describe('GET /api/users', () => {
    // Tests for listing users
  });
  
  describe('GET /api/users/:id', () => {
    // Tests for retrieving a specific user
  });
  
  describe('POST /api/users', () => {
    // Tests for creating users
  });
  
  describe('PUT /api/users/:id', () => {
    // Tests for updating users
  });
  
  describe('DELETE /api/users/:id', () => {
    // Tests for deleting users
  });
});</pre>
                </div>
                
                <div class="video-card">
                    <div class="video-container">
                        <iframe src="https://fast.wistia.net/embed/iframe/xr8hp7d4n0" title="Testing Environment Setup" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                    <h3>Setting Up Testing Environments</h3>
                    <p>Setting up the right testing environment is essential for reliable and efficient tests.</p>
                    
                    <h4>Key Components of a Testing Environment:</h4>
                    <ul>
                        <li>Dedicated test database that resets between test runs</li>
                        <li>Environment-specific configuration (using <code>NODE_ENV=test</code>)</li>
                        <li>Mock services for external dependencies</li>
                        <li>Continuous integration setup to run tests automatically</li>
                    </ul>
                    
                    <h4>Code Example - Jest Setup File:</h4>
                    <pre>
// jest.setup.js
const db = require('./data/dbConfig');

// Global setup before all tests
beforeAll(async () => {
  // Run migrations to set up the test database schema
  await db.migrate.latest();
});

// Global cleanup after all tests
afterAll(async () => {
  // Close database connection
  await db.destroy();
});

// Reset database before each test suite
beforeEach(async () => {
  // Run seeds to reset to a known state
  await db.seed.run();
});</pre>
                    
                    <h4>Jest Configuration:</h4>
                    <pre>
// jest.config.js
module.exports = {
  testEnvironment: 'node',
  setupFilesAfterEnv: ['./jest.setup.js'],
  collectCoverageFrom: [
    '**/*.{js,jsx}',
    '!**/node_modules/**',
    '!**/vendor/**',
    '!**/*.config.js',
  ],
  testPathIgnorePatterns: ['/node_modules/'],
  verbose: true
};</pre>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Guided Project</h2>
            <div class="module-card">
                <h3>Backend Testing Implementation</h3>
                <p>Build a comprehensive test suite for a Node.js backend application</p>
                <a href="https://github.com/bloominstituteoftechnology/node-backend-testing-guided" class="button" target="_blank" rel="noopener noreferrer">View Project</a>
            </div>
        </div>

        <div class="section">
            <h2>Resources</h2>
            <div class="module-grid">
                <div class="module-card">
                    <h3>Recommended Reading</h3>
                    <ul class="resource-link-list">
                        <li><a href="https://jestjs.io/docs/supertest" target="_blank" rel="noopener noreferrer">Jest SuperTest Documentation</a></li>
                        <li><a href="https://github.com/visionmedia/supertest#readme" target="_blank" rel="noopener noreferrer">SuperTest Documentation</a></li>
                        <li><a href="https://www.postman.com/testing/" target="_blank" rel="noopener noreferrer">Postman Testing Guide</a></li>
                    </ul>
                </div>
                <div class="module-card">
                    <h3>Tools & Libraries</h3>
                    <ul>
                        <li>SuperTest - HTTP Testing Library</li>
                        <li>Postman - API Testing Tool</li>
                        <li>TestContainers - Database Testing</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 